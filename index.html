<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neko Adventure</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#0d0d1a;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:'Courier New',monospace;}
#hud{width:512px;display:flex;justify-content:space-between;background:#0d0d1a;border:2px solid #4c1d95;border-bottom:none;padding:4px 10px;font-size:11px;color:#c4b5fd;}
#hud span{color:#fbbf24;}
#mission{width:512px;background:#0d0d1a;border:1px solid #6d28d9;border-bottom:none;padding:3px 10px;font-size:10px;color:#a78bfa;min-height:18px;}
canvas{display:block;image-rendering:pixelated;border:2px solid #4c1d95;cursor:pointer;}
#info{width:512px;background:#0a0a14;padding:3px 10px;font-size:9px;color:#3b2a6e;text-align:center;}
</style>
</head>
<body>
<div id="hud">
  <div>‚ù§Ô∏è<span id="hpV">3</span> &nbsp;‚≠ê<span id="scV">0</span></div>
  <div>FASE <span id="lvV">1</span>/3</div>
  <div>üêü<span id="fishV">0/6</span> &nbsp;üëæ<span id="enV">0/3</span></div>
</div>
<div id="mission">üéØ Pressione ENTER para come√ßar</div>
<canvas id="c" width="512" height="320" tabindex="0"></canvas>
<div id="info">‚Üê ‚Üí ou A D = mover &nbsp;|&nbsp; Z ou ESPA√áO = pular &nbsp;|&nbsp; ENTER = iniciar &nbsp;|&nbsp; Clique no jogo primeiro!</div>

<script>
const C = document.getElementById('c');
const ctx = C.getContext('2d');
ctx.imageSmoothingEnabled = false;

// Focus canvas on click
C.addEventListener('click', () => C.focus());
C.focus();

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
const K = {};
window.addEventListener('keydown', e => {
  K[e.code] = true;
  K[e.key] = true;
  if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault();
});
window.addEventListener('keyup', e => {
  K[e.code] = false;
  K[e.key] = false;
});

const MK = {left:false, right:false, jump:false};

function px(x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(Math.round(x),Math.round(y),w,h);}
function pxa(x,y,w,h,c,a){ctx.globalAlpha=a;px(x,y,w,h,c);ctx.globalAlpha=1;}

// ‚îÄ‚îÄ DRAW PLAYER (siamese cat) ‚îÄ‚îÄ
function drawCat(x,y,fr,dir,pow,inv){
  if(inv>0 && Math.floor(inv/6)%2===0) return;
  ctx.save();
  x=Math.round(x); y=Math.round(y);
  if(dir===-1){ctx.translate(x*2+16,0);ctx.scale(-1,1);}
  const b=Math.sin(fr*0.3);
  // tail
  px(x-4+Math.sin(fr*0.2)*3, y+13, 5, 3, '#c8a882');
  // body
  px(x,   y+8,  16, 11, pow?'#fde68a':'#e8d5b0');
  px(x,   y+8,   4, 11, '#8b6344');
  px(x+12,y+8,   4, 11, '#8b6344');
  px(x+2, y+16,  12, 3,  '#8b6344');
  // head
  px(x+2, y+1,  12,  8, pow?'#fde68a':'#e8d5b0');
  px(x+2, y+1,   4,  6, '#8b6344');
  px(x+10,y+1,   4,  6, '#8b6344');
  // ears
  px(x+2, y-3,   4,  4, '#8b6344');
  px(x+10,y-3,   4,  4, '#8b6344');
  px(x+3, y-2,   2,  2, '#f9a8d4');
  px(x+11,y-2,   2,  2, '#f9a8d4');
  // eyes
  px(x+4, y+3,   3,  2, '#60a5fa');
  px(x+9, y+3,   3,  2, '#60a5fa');
  px(x+5, y+3,   1,  2, '#000');
  px(x+10,y+3,   1,  2, '#000');
  // nose + whiskers
  px(x+7, y+6,   2,  1, '#f9a8d4');
  px(x-2, y+6,   4,  1, '#ccc');
  px(x+14,y+6,   4,  1, '#ccc');
  // legs walk
  const lg = player.onGround ? Math.sin(fr*0.35)*3 : 2;
  px(x+2, y+18,  4, 4+lg, '#8b6344');
  px(x+10,y+18,  4, 4-lg, '#8b6344');
  if(pow){pxa(x-2,y-4,20,28,'#fbbf24',0.25);}
  ctx.restore();
}

function drawDog(x,y,fr){
  x=Math.round(x);y=Math.round(y);
  const b=Math.floor(fr/10)%2;
  px(x,   y+b,   14, 10, '#92400e');
  px(x+2, y-4+b, 10,  6, '#92400e');
  px(x+1, y-6+b,  3,  5, '#78350f');
  px(x+9, y-6+b,  3,  5, '#78350f');
  px(x+3, y-2+b,  2,  2, '#fff');
  px(x+8, y-2+b,  2,  2, '#fff');
  px(x+4, y-2+b,  1,  2, '#111');
  px(x+9, y-2+b,  1,  2, '#111');
  px(x+5, y+2+b,  3,  1, '#111');
  px(x+2, y+10,   3,  5, '#92400e');
  px(x+9, y+10,   3,  5, '#92400e');
}

function drawNinja(x,y,fr){
  x=Math.round(x);y=Math.round(y);
  const b=Math.floor(fr/8)%2;
  px(x+2,y+b,  10, 9,'#1e1b4b');
  px(x+3,y-4+b, 8, 6,'#1e1b4b');
  px(x+3,y-2+b, 2, 2,'#ef4444');
  px(x+9,y-2+b, 2, 2,'#ef4444');
  px(x+2,y+9,   4, 5,'#1e1b4b');
  px(x+8,y+9,   4, 5,'#1e1b4b');
}

function drawRobot(x,y,fr){
  x=Math.round(x);y=Math.round(y);
  const b=Math.floor(fr/9)%2;
  px(x,  y+b,  14,10,'#374151');
  px(x+1,y-5+b,12, 7,'#1f2937');
  px(x+2,y-3+b, 3, 3,'#06b6d4');
  px(x+8,y-3+b, 3, 3,'#06b6d4');
  px(x+4,y+2+b, 5, 1,'#000');
  px(x+2,y+10,  4, 5,'#374151');
  px(x+8,y+10,  4, 5,'#374151');
}

function drawBoss(x,y,fr,hp,maxHp,phase){
  x=Math.round(x);y=Math.round(y);
  const b=Math.sin(fr*0.08)*2;
  const stun=boss&&boss.stunTimer>0;
  const cols=[['#7c2d12','#92400e'],['#312e81','#3730a3'],['#1f2937','#374151']];
  const [c1,c2]=cols[phase];
  const sc=stun?'#ef4444':c1;
  const W=phase===2?52:phase===1?46:42;
  const H=phase===2?36:phase===1?32:28;
  px(x,    y+12+b, W,   H,   sc);
  px(x+4,  y+b,    W-8, 14,  stun?'#ef4444':c2);
  px(x+2,  y-7+b,  10,  9,   sc);
  px(x+W-12,y-7+b, 10,  9,   sc);
  // eyes
  const ec=stun?'#fff':phase===2?'#06b6d4':'#fef3c7';
  px(x+6,  y+2+b,  7,5, ec);
  px(x+W-13,y+2+b, 7,5, ec);
  px(x+8,  y+3+b,  3,3,'#000');
  px(x+W-11,y+3+b, 3,3,'#000');
  // mouth
  px(x+10, y+10+b, W-20, 2,'#000');
  px(x+10, y+10+b, 4, 4,'#fff');
  px(x+W-14,y+10+b,4, 4,'#fff');
  // legs
  px(x+4,  y+H+12, 10,10, sc);
  px(x+W-14,y+H+12,10,10, sc);
  // phase 2 rockets (final boss)
  if(phase===2&&hp<maxHp/2){
    pxa(x+6,y+H+20,8,14,'#f97316',0.6+Math.sin(fr*0.4)*0.3);
    pxa(x+W-14,y+H+20,8,14,'#f97316',0.6+Math.cos(fr*0.4)*0.3);
  }
  // HP bar
  const bw=W;
  px(x,y-14,bw,5,'#3f0000');
  px(x,y-14,Math.max(0,Math.floor(bw*(hp/maxHp))),5,hp>maxHp/2?'#22c55e':'#ef4444');
  ctx.fillStyle='#fff';ctx.font='7px Courier New';
  ctx.fillText(`BOSS ${hp}HP`,x,y-16);
}

function drawCoin(x,y,f){
  x=Math.round(x);y=Math.round(y);
  const c=Math.floor(f/8)%2?'#f59e0b':'#fbbf24';
  px(x+1,y,  6,8,c);
  px(x,  y+1,8,6,c);
  px(x+2,y+2,4,4,'#fde68a');
}

function drawKey(x,y){
  x=Math.round(x);y=Math.round(y);
  const b=Math.sin(frame*0.1)*2;
  px(x+2,y+b,  6,6,'#fbbf24');
  px(x,  y+1+b,9,4,'#fbbf24');
  px(x+8,y+6+b,2,6,'#fbbf24');
  px(x+6,y+10+b,4,2,'#fbbf24');
  ctx.fillStyle='#fde68a';ctx.font='8px Courier New';
  ctx.textAlign='center';ctx.fillText('KEY',x+5,y-2+b);ctx.textAlign='left';
}

function drawDoor(x,y,open){
  x=Math.round(x);y=Math.round(y);
  px(x,  y,   22,40, open?'#166534':'#991b1b');
  px(x+2,y+2, 18,36, open?'#15803d':'#7f1d1d');
  px(x+7,y+16, 8, 8,'#fbbf24');
  if(!open) px(x+9,y+18,4,4,'#000');
  ctx.fillStyle=open?'#bbf7d0':'#fca5a5';
  ctx.font='7px Courier New';ctx.textAlign='center';
  ctx.fillText(open?'ABERTA':'FECHADA',x+11,y-4);ctx.textAlign='left';
}

function drawMilk(x,y){
  const b=Math.sin(frame*0.1)*2;
  px(x+2,y+b,  8,2,'#e2d9f3');
  px(x+1,y+2+b,10,8,'#f8fafc');
  ctx.fillStyle='#a78bfa';ctx.font='7px Courier New';ctx.textAlign='center';
  ctx.fillText('MILK',x+6,y-2+b);ctx.textAlign='left';
}

function drawFishPU(x,y){
  const b=Math.sin(frame*0.12)*2;
  px(x+2,y+2+b, 8,4,'#60a5fa');
  px(x,  y+3+b, 3,2,'#93c5fd');
  px(x+10,y+1+b,4,3,'#3b82f6');
  px(x+10,y+4+b,4,3,'#3b82f6');
  ctx.fillStyle='#6ee7b7';ctx.font='7px Courier New';ctx.textAlign='center';
  ctx.fillText('+VIDA',x+6,y-2+b);ctx.textAlign='left';
}

// ‚îÄ‚îÄ LEVEL DATA ‚îÄ‚îÄ
const LEVELS = [
  {
    name:'Vila do Gato', lw:2200,
    bgTop:'#1a0a2e', bgBot:'#2e1065',
    grassCol:'#7c3aed', platCol:'#3b1f6e', platCol2:'#5b21b6',
    enemyType:'dog', enemyNeeded:3, fishNeeded:6,
    bossHp:20, bossPhase:0,
    plats:[
      [0,288,2200,32],[140,238,90,12],[290,198,80,12],[420,242,70,12],
      [540,194,100,12],[680,244,80,12],[800,194,90,12],[950,240,80,12],
      [1080,188,100,12],[1230,240,80,12],[1360,184,90,12],[1500,234,80,12],
      [1630,184,100,12],[1780,240,80,12],[1900,188,90,12],[2080,234,80,12],
    ],
    coins:[[160,218],[310,178],[560,174],[700,224],[820,174],[970,220],[1100,168],
           [1250,220],[1380,164],[1520,214],[1650,164],[1800,220],[1920,168],[2095,214]],
    enemies:[[380,262],[740,262],[1150,262],[1550,262],[1950,262]],
    pups:[{x:560,y:169,t:'milk'},{x:1080,y:163,t:'fish'},{x:1900,y:163,t:'milk'}],
    keyPos:[2090,210], doorPos:[2140,248],
  },
  {
    name:'Floresta Ninja', lw:2400,
    bgTop:'#052e16', bgBot:'#064e3b',
    grassCol:'#16a34a', platCol:'#14532d', platCol2:'#166534',
    enemyType:'ninja', enemyNeeded:4, fishNeeded:8,
    bossHp:30, bossPhase:1,
    plats:[
      [0,288,2400,32],[120,238,80,12],[260,198,80,12],[390,248,70,12],
      [510,194,90,12],[650,244,80,12],[770,194,90,12],[910,238,80,12],
      [1040,184,100,12],[1190,238,80,12],[1320,180,90,12],[1460,232,80,12],
      [1590,180,100,12],[1740,238,80,12],[1870,184,90,12],[2020,232,80,12],
      [2150,180,100,12],[2290,232,80,12],
    ],
    coins:[[140,218],[280,178],[530,174],[670,224],[790,174],[930,218],[1060,164],
           [1210,218],[1340,160],[1480,212],[1610,160],[1760,218],[1890,164],[2040,212],[2170,160],[2310,212]],
    enemies:[[340,262],[680,262],[1100,262],[1500,262],[1900,262],[2200,262]],
    pups:[{x:510,y:169,t:'milk'},{x:1040,y:159,t:'fish'},{x:1870,y:159,t:'milk'},{x:2150,y:155,t:'fish'}],
    keyPos:[2300,208], doorPos:[2350,248],
  },
  {
    name:'Castelo do Rob√¥', lw:2600,
    bgTop:'#0f172a', bgBot:'#1e293b',
    grassCol:'#475569', platCol:'#1e293b', platCol2:'#334155',
    enemyType:'robot', enemyNeeded:5, fishNeeded:10,
    bossHp:45, bossPhase:2,
    plats:[
      [0,288,2600,32],[100,235,90,12],[250,192,80,12],[380,245,70,12],
      [500,190,90,12],[640,240,80,12],[760,188,90,12],[900,235,80,12],
      [1030,182,100,12],[1180,235,80,12],[1310,178,90,12],[1450,228,80,12],
      [1580,176,100,12],[1730,235,80,12],[1860,180,90,12],[2010,228,80,12],
      [2140,175,100,12],[2290,228,80,12],[2420,175,90,12],[2530,250,70,12],
    ],
    coins:[[120,215],[270,172],[520,170],[660,220],[780,168],[920,215],[1050,162],
           [1200,215],[1330,158],[1470,208],[1600,156],[1750,215],[1880,160],[2030,208],
           [2160,155],[2310,208],[2440,155],[2545,230]],
    enemies:[[300,262],[650,262],[1050,262],[1450,262],[1850,262],[2250,262],[2500,262]],
    pups:[{x:500,y:165,t:'milk'},{x:1030,y:157,t:'fish'},{x:1580,y:151,t:'milk'},{x:2140,y:150,t:'fish'},{x:2420,y:150,t:'milk'}],
    keyPos:[2540,226], doorPos:[2560,248],
  }
];

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ
let state='title', frame=0, lvIdx=0;
let player, plats, coins, enemies, pups, parts, projs;
let boss, bossActive, bossDefeated;
let keyItem, door, hasKey;
let camX=0, score=0, lives=3, powerTimer=0, invTimer=0;
let enemiesKilled=0, fishCount=0, mStep=0;

const GRAV=0.42, JUMP=-9.2, SPD=2.8;

function initLevel(i){
  lvIdx=i;
  const L=LEVELS[i];
  boss=null;bossActive=false;bossDefeated=false;
  parts=[];projs=[];powerTimer=0;invTimer=0;
  camX=0;enemiesKilled=0;fishCount=0;mStep=0;hasKey=false;

  player={x:40,y:230,vx:0,vy:0,onGround:false,dir:1,anim:0,w:16,h:22};

  plats=L.plats.map(([x,y,w,h],idx)=>({x,y,w,h,col:idx%2===0?L.platCol:L.platCol2}));
  coins=L.coins.map(([x,y])=>({x,y,alive:true,f:Math.random()*16}));
  enemies=L.enemies.map(([x,y])=>({x,y,vx:-1.3,alive:true,anim:0,w:14,h:16}));
  pups=L.pups.map(p=>({...p,alive:true}));
  keyItem={x:L.keyPos[0],y:L.keyPos[1],alive:true};
  door={x:L.doorPos[0],y:L.doorPos[1],open:false};

  updHUD(); updMission();
}

function updMission(){
  const L=LEVELS[lvIdx];
  const msgs=[
    `üéØ Miss√£o 1/3: Derrote inimigos (${enemiesKilled}/${L.enemyNeeded})`,
    `üéØ Miss√£o 2/3: Colete peixinhos (${fishCount}/${L.fishNeeded})`,
    `üéØ Miss√£o 3/3: Ache a üîë chave e abra a üö™ porta!`,
    bossDefeated?`‚úÖ Fase ${lvIdx+1} completa! ENTER para avan√ßar`:`‚ö†Ô∏è BOSS: ${boss?boss.hp:0} HP restantes! Pise nele!`,
  ];
  document.getElementById('mission').textContent=msgs[Math.min(mStep,3)];
}

function checkMissions(){
  const L=LEVELS[lvIdx];
  if(mStep===0&&enemiesKilled>=L.enemyNeeded){mStep=1;msg('‚úÖ Miss√£o 1 OK! Agora colete os peixinhos!');}
  if(mStep===1&&fishCount>=L.fishNeeded){mStep=2;msg('‚úÖ Miss√£o 2 OK! Ache a chave dourada!');}
  if(mStep===2&&hasKey&&!door.open){
    door.open=true;mStep=3;
    spawnBoss();
    msg('üö™ Porta aberta! ‚ö†Ô∏è O BOSS apareceu!');
  }
  updMission();
}

function spawnBoss(){
  const L=LEVELS[lvIdx];
  const W=L.bossPhase===2?52:L.bossPhase===1?46:42;
  boss={x:L.lw-300,y:200,vx:-2,vy:0,hp:L.bossHp,maxHp:L.bossHp,
        anim:0,w:W,h:W,stunTimer:0,phase2:false,projTimer:0,onGround:false};
  bossActive=true;
}

// ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ
function updPlayer(){
  player.anim++;
  const pow=powerTimer>0;

  const goL=K['ArrowLeft']||K['KeyA']||K['a']||MK.left;
  const goR=K['ArrowRight']||K['KeyD']||K['d']||MK.right;
  const doJ=K['KeyZ']||K['z']||K['Space']||K[' ']||K['ArrowUp']||MK.jump;

  if(goL){player.vx=-(SPD*(pow?1.6:1));player.dir=-1;}
  else if(goR){player.vx=SPD*(pow?1.6:1);player.dir=1;}
  else player.vx*=0.75;

  if(doJ&&player.onGround){
    player.vy=JUMP*(pow?1.15:1);
    player.onGround=false;
    spawnP(player.x+8,player.y+22,'#a78bfa',4);
  }

  player.vy=Math.min(player.vy+GRAV,12);
  player.x+=player.vx;
  player.y+=player.vy;
  player.onGround=false;

  for(const p of plats){
    if(player.x+player.w>p.x&&player.x<p.x+p.w&&
       player.y+player.h>p.y&&player.y+player.h<p.y+p.h+10&&player.vy>=0){
      player.y=p.y-player.h;player.vy=0;player.onGround=true;
    }
  }
  // left wall
  player.x=Math.max(0,player.x);
  if(player.y>360) die();
  if(powerTimer>0) powerTimer--;
  if(invTimer>0) invTimer--;
}

function updEnemies(){
  const L=LEVELS[lvIdx];
  for(const e of enemies){
    if(!e.alive) continue;
    e.anim++;e.x+=e.vx;
    let onP=false;
    for(const p of plats){
      if(e.x+e.w>p.x&&e.x<p.x+p.w&&e.y+e.h>=p.y&&e.y+e.h<=p.y+14) onP=true;
    }
    if(!onP||e.x<5||e.x>L.lw-20) e.vx*=-1;
    if(invTimer===0&&ovlp(player,e)){
      if(player.vy>0&&player.y+player.h<e.y+8){
        e.alive=false;player.vy=-7;score+=10;enemiesKilled++;
        spawnP(e.x+7,e.y,'#fbbf24',7);checkMissions();updHUD();
      } else die();
    }
  }
}

function updBoss(){
  if(!boss) return;
  boss.anim++;boss.stunTimer=Math.max(0,boss.stunTimer-1);
  boss.x+=boss.vx;
  boss.vy=Math.min(boss.vy+GRAV*0.5,8);
  boss.y+=boss.vy;
  boss.onGround=false;
  for(const p of plats){
    if(boss.x+boss.w>p.x&&boss.x<p.x+p.w&&
       boss.y+boss.h>p.y&&boss.y+boss.h<p.y+boss.h+4&&boss.vy>=0){
      boss.y=p.y-boss.h;boss.vy=0;boss.onGround=true;
    }
  }
  const L=LEVELS[lvIdx];
  if(boss.x<20||boss.x>L.lw-boss.w-20) boss.vx*=-1;
  if(!boss.phase2&&boss.hp<boss.maxHp/2){boss.phase2=true;boss.vx*=1.5;msg('‚ö†Ô∏è Boss ficou furioso!');}
  if(boss.phase2&&boss.onGround) boss.vy=-7;
  // projectiles (last boss)
  if(L.bossPhase===2&&boss.phase2){
    boss.projTimer++;
    if(boss.projTimer>90){
      boss.projTimer=0;
      const dx=player.x-boss.x,dy=player.y-boss.y,d=Math.sqrt(dx*dx+dy*dy)||1;
      projs.push({x:boss.x+boss.w/2,y:boss.y+boss.h/2,vx:dx/d*3.5,vy:dy/d*3.5,life:100});
    }
  }
  if(invTimer===0&&ovlp(player,boss)){
    if(player.vy>1&&player.y+player.h<boss.y+16&&boss.stunTimer===0){
      boss.hp--;boss.stunTimer=45;player.vy=-8;score+=20;
      spawnP(boss.x+boss.w/2,boss.y,'#ef4444',8);updMission();
      if(boss.hp<=0){
        bossActive=false;bossDefeated=true;boss=null;projs=[];score+=150;
        updHUD();updMission();
        if(lvIdx<2){state='clear';msg('üèÜ Boss derrotado! ENTER = pr√≥xima fase!');}
        else{state='win';msg('üèÜ VOC√ä VENCEU! Parab√©ns!!');}
      }
    } else die();
  }
}

function updProjs(){
  for(let i=projs.length-1;i>=0;i--){
    const p=projs[i];p.x+=p.vx;p.y+=p.vy;p.life--;
    if(p.life<=0){projs.splice(i,1);continue;}
    if(invTimer===0&&ovlp(player,{x:p.x-3,y:p.y-3,w:6,h:6})){die();projs.splice(i,1);}
  }
}

function updCoins(){
  for(const c of coins){
    if(!c.alive)continue;c.f++;
    if(ovlp(player,{x:c.x,y:c.y,w:8,h:8})){
      c.alive=false;score+=2;fishCount++;
      spawnP(c.x,c.y,'#fbbf24',5);checkMissions();updHUD();
    }
  }
}

function updPups(){
  for(const p of pups){
    if(!p.alive)continue;
    if(ovlp(player,{x:p.x,y:p.y,w:14,h:12})){
      p.alive=false;
      if(p.t==='milk'){powerTimer=360;msg('ü•õ Super Leite! Velocidade turbo!');}
      else{lives=Math.min(5,lives+1);score+=20;msg('üêü Peixe m√°gico! +1 vida!');}
      spawnP(p.x,p.y,'#a78bfa',8);updHUD();
    }
  }
}

function updKey(){
  if(!keyItem.alive)return;
  if(ovlp(player,{x:keyItem.x,y:keyItem.y,w:10,h:14})){
    keyItem.alive=false;hasKey=true;msg('üîë Chave pega! V√° at√© a porta!');checkMissions();
  }
}

function die(){
  if(invTimer>0)return;
  lives--;invTimer=100;spawnP(player.x+8,player.y,'#ef4444',10);updHUD();
  if(lives<=0){state='over';msg('üòø Game Over! ENTER = tentar de novo');}
}

function ovlp(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

function spawnP(x,y,col,n){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=Math.random()*3+1;
    parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,life:30,col});
  }
}
function updParts(){
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life--;
    if(p.life<=0)parts.splice(i,1);
  }
}

function updCam(){
  const L=LEVELS[lvIdx];
  camX+=(player.x-180-camX)*0.12;
  camX=Math.max(0,Math.min(L.lw-512,camX));
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
function drawBg(){
  const L=LEVELS[lvIdx];
  const g=ctx.createLinearGradient(0,0,0,320);
  g.addColorStop(0,L.bgTop);g.addColorStop(1,L.bgBot);
  ctx.fillStyle=g;ctx.fillRect(0,0,512,320);
  ctx.fillStyle='#ffffff14';
  for(let i=0;i<40;i++) ctx.fillRect(((i*137+frame*0.15)%512+512)%512,(i*79)%200,1,1);
}

function drawWorld(){
  const L=LEVELS[lvIdx];
  ctx.save();ctx.translate(-camX,0);

  // platforms
  for(const p of plats){
    px(p.x,p.y,p.w,p.h,p.col);
    pxa(p.x,p.y,p.w,3,'#fff',0.08);
    if(p.h>20) for(let gx=p.x;gx<p.x+p.w;gx+=4) px(gx,p.y-2,2,3,L.grassCol);
  }

  // door
  drawDoor(door.x,door.y,door.open);
  if(keyItem.alive) drawKey(keyItem.x,keyItem.y);

  // coins
  for(const c of coins) if(c.alive) drawCoin(c.x,c.y,c.f);

  // powerups
  for(const p of pups){
    if(!p.alive)continue;
    if(p.t==='milk') drawMilk(p.x,p.y); else drawFishPU(p.x,p.y);
  }

  // enemies
  for(const e of enemies){
    if(!e.alive)continue;
    if(L.enemyType==='dog') drawDog(e.x,e.y,e.anim);
    else if(L.enemyType==='ninja') drawNinja(e.x,e.y,e.anim);
    else drawRobot(e.x,e.y,e.anim);
  }

  // boss
  if(boss) drawBoss(boss.x,boss.y,boss.anim,boss.hp,boss.maxHp,LEVELS[lvIdx].bossPhase);

  // projectiles
  for(const p of projs){
    pxa(p.x-3,p.y-3,6,6,'#f97316',p.life/100);
    pxa(p.x-1,p.y-1,3,3,'#fbbf24',p.life/100);
  }

  // particles
  for(const p of parts){pxa(p.x,p.y,3,3,p.col,p.life/30);}

  // player
  drawCat(player.x,player.y,player.anim,player.dir,powerTimer>0,invTimer);

  ctx.restore();

  // power bar
  if(powerTimer>0){
    px(8,8,104,7,'#1e1b4b');
    px(8,8,Math.floor(104*powerTimer/360),7,'#f59e0b');
    ctx.fillStyle='#fde68a';ctx.font='7px Courier New';ctx.fillText('PWR',116,14);
  }
  if(hasKey&&!door.open){
    ctx.fillStyle='#fbbf24';ctx.font='9px Courier New';ctx.fillText('üîë com voc√™!',8,28);
  }
}

function drawOverlay(title,sub,col,blink){
  ctx.fillStyle='#000000bb';ctx.fillRect(80,90,352,150);
  px(80,90,352,3,col);px(80,237,352,3,col);
  ctx.textAlign='center';
  ctx.fillStyle=col;ctx.font='bold 18px Courier New';ctx.fillText(title,256,125);
  ctx.fillStyle='#c4b5fd';ctx.font='10px Courier New';ctx.fillText(sub,256,155);
  ctx.fillStyle='#fff';ctx.font='9px Courier New';ctx.fillText(`Score: ${score}  |  Vidas: ${lives}`,256,178);
  if(blink&&Math.floor(frame/20)%2===0){
    ctx.fillStyle='#fbbf24';ctx.fillText('ENTER para continuar',256,215);
  }
  ctx.textAlign='left';
}

function drawTitle(){
  const g=ctx.createLinearGradient(0,0,0,320);
  g.addColorStop(0,'#1a0a2e');g.addColorStop(1,'#2e1065');
  ctx.fillStyle=g;ctx.fillRect(0,0,512,320);
  for(let i=0;i<50;i++){ctx.fillStyle='#fff';ctx.fillRect((i*137+frame)%512,(i*73)%240,1,1);}
  ctx.textAlign='center';
  ctx.fillStyle='#fbbf24';ctx.font='bold 26px Courier New';ctx.fillText('üê± NEKO ADVENTURE',256,60);
  ctx.fillStyle='#a78bfa';ctx.font='11px Courier New';ctx.fillText('A aventura do gatinho siam√™s!',256,82);
  // draw cat on title
  if(player) drawCat(240,120,frame,1,false,0);
  ctx.fillStyle='#c4b5fd';ctx.font='10px Courier New';
  ctx.fillText('3 FASES  ‚Ä¢  MISS√ïES  ‚Ä¢  BOSSES  ‚Ä¢  POWER-UPS',256,190);
  ctx.fillText('Fase 1: Vila do Gato  ‚Üí  Floresta Ninja  ‚Üí  Castelo do Rob√¥',256,208);
  if(Math.floor(frame/20)%2===0){
    ctx.fillStyle='#fbbf24';ctx.font='13px Courier New';ctx.fillText('‚ñ∂  ENTER para jogar  ‚óÄ',256,248);
  }
  ctx.fillStyle='#4b3a6e';ctx.font='9px Courier New';
  ctx.fillText('‚Üê ‚Üí mover  |  Z / ESPA√áO = pular  |  Pise nos inimigos!',256,278);
  ctx.textAlign='left';
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
function updHUD(){
  const L=LEVELS[lvIdx];
  document.getElementById('hpV').textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives))||'üíÄ';
  document.getElementById('scV').textContent=score;
  document.getElementById('lvV').textContent=lvIdx+1;
  document.getElementById('fishV').textContent=`${fishCount}/${L.fishNeeded}`;
  document.getElementById('enV').textContent=`${enemiesKilled}/${L.enemyNeeded}`;
}

let msgT=0;
function msg(t){document.getElementById('mission').textContent=t;msgT=220;}

// ‚îÄ‚îÄ LOOP ‚îÄ‚îÄ
function loop(){
  frame++;
  ctx.clearRect(0,0,512,320);

  if(state==='title'){
    drawTitle();
  } else {
    updCam();
    if(state==='play'){
      updPlayer();updEnemies();
      if(bossActive)updBoss();
      updProjs();updCoins();updPups();updKey();updParts();
    }
    drawBg();drawWorld();
    if(state==='clear') drawOverlay(`üèÜ FASE ${lvIdx+1} COMPLETA!`,`${LEVELS[lvIdx].name} ‚Äî Pr√≥xima: ${LEVELS[lvIdx+1]?.name||'?'}`,'#fbbf24',true);
    if(state==='over')  drawOverlay('üòø GAME OVER','N√£o desista! Tente de novo!','#ef4444',true);
    if(state==='win')   drawOverlay('üèÜ VOC√ä GANHOU!','Parab√©ns! O gatinho salvou o dia! üéâ','#22c55e',true);
  }
  if(msgT>0){msgT--;if(msgT===0)updMission();}
  requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ ENTER key ‚îÄ‚îÄ
window.addEventListener('keydown', e => {
  if(e.code!=='Enter'&&e.key!=='Enter') return;
  if(state==='title'||state==='over'){score=0;lives=3;initLevel(0);state='play';}
  else if(state==='clear'){initLevel(lvIdx+1);state='play';}
  else if(state==='win'){score=0;lives=3;initLevel(0);state='play';}
});

// ‚îÄ‚îÄ MOBILE BUTTONS ‚îÄ‚îÄ
function addMobile(id,k){
  const el=document.getElementById(id);if(!el)return;
  el.addEventListener('touchstart',e=>{e.preventDefault();MK[k]=true;},{passive:false});
  el.addEventListener('touchend',  e=>{e.preventDefault();MK[k]=false;},{passive:false});
  el.addEventListener('mousedown', ()=>MK[k]=true);
  el.addEventListener('mouseup',   ()=>MK[k]=false);
}

// Create mobile buttons dynamically
const mDiv=document.createElement('div');
mDiv.style.cssText='width:512px;display:flex;justify-content:space-between;padding:6px 10px;background:#0a0a14;border:2px solid #4c1d95;border-top:none;';
mDiv.innerHTML=`
  <div style="display:flex;gap:8px">
    <button id="btnL" style="background:#ffffff18;border:2px solid #7c3aed;color:#a78bfa;font-size:16px;width:52px;height:44px;border-radius:8px;cursor:pointer;">‚óÄ</button>
    <button id="btnR" style="background:#ffffff18;border:2px solid #7c3aed;color:#a78bfa;font-size:16px;width:52px;height:44px;border-radius:8px;cursor:pointer;">‚ñ∂</button>
  </div>
  <button id="btnJ" style="background:#7c3aed44;border:2px solid #7c3aed;color:#fbbf24;font-size:14px;width:80px;height:44px;border-radius:8px;cursor:pointer;">üêæ PULAR</button>`;
C.after(mDiv);
addMobile('btnL','left');addMobile('btnR','right');addMobile('btnJ','jump');

// init + start
initLevel(0);
loop();
</script>
</body>
</html>
