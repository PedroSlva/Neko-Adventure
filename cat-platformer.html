<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neko Adventure</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:'Courier New',monospace;overflow:hidden;}
#wrapper{position:relative;width:512px;}
canvas{display:block;image-rendering:pixelated;}
#hud{display:flex;justify-content:space-between;align-items:center;background:#0d0d1a;border:2px solid #4c1d95;padding:4px 10px;font-size:11px;color:#c4b5fd;}
#hud span{color:#fbbf24;}
#mission{background:#0d0d1a;border:1px solid #6d28d9;border-top:none;padding:3px 10px;font-size:10px;color:#a78bfa;min-height:18px;}
#controls{background:#0d0d0d;padding:2px 10px;font-size:9px;color:#3b2a6e;text-align:center;}
/* Mobile buttons */
#mobileCtrl{display:none;position:absolute;bottom:40px;left:0;right:0;pointer-events:none;}
#mobileCtrl button{pointer-events:all;background:#ffffff18;border:2px solid #7c3aed55;color:#a78bfa;font-size:18px;width:48px;height:48px;border-radius:8px;cursor:pointer;user-select:none;}
@media(max-width:600px){#mobileCtrl{display:flex;justify-content:space-between;padding:0 10px;}}
</style>
</head>
<body>
<div id="wrapper">
  <div id="hud">
    <div>‚ù§Ô∏è <span id="hpV">3</span> &nbsp;‚≠ê<span id="scV">0</span></div>
    <div>FASE <span id="lvV">1</span>/3 &nbsp;üëæ<span id="enV">0</span> mortos</div>
    <div>üêü<span id="fishV">0/0</span> &nbsp;ü•õ<span id="pwV">-</span></div>
  </div>
  <div id="mission">üéØ Miss√£o: ‚Äî</div>
  <canvas id="c" width="512" height="320"></canvas>
  <div id="mobileCtrl">
    <div style="display:flex;gap:6px">
      <button id="btnL">‚óÄ</button>
      <button id="btnR">‚ñ∂</button>
    </div>
    <button id="btnJ">üêæ</button>
  </div>
  <div id="controls">‚Üê ‚Üí mover &nbsp;|&nbsp; Z / ESPA√áO pular &nbsp;|&nbsp; ENTER iniciar/avan√ßar</div>
</div>

<script>
const C=document.getElementById('c'), ctx=C.getContext('2d');
ctx.imageSmoothingEnabled=false;

// ‚îÄ‚îÄ PIXEL HELPERS ‚îÄ‚îÄ
const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);}
const pxA=(x,y,w,h,c,a)=>{ctx.globalAlpha=a;px(x,y,w,h,c);ctx.globalAlpha=1;}

// ‚îÄ‚îÄ SPRITE DRAWERS ‚îÄ‚îÄ
function drawCat(x,y,fr,dir,pow,inv){
  if(inv&&Math.floor(inv/5)%2===0) return;
  ctx.save();
  if(dir===-1){ctx.translate(x*2+16,0);ctx.scale(-1,1);}
  const bob=Math.sin(fr*0.3)*1;
  // tail
  const tf=Math.sin(fr*0.25)*4;
  px(x-5+tf,y+12+bob,5,3,'#c8a882');
  // body
  const bc=pow?'#fde68a':'#e8d5b0';
  px(x,y+7+bob,16,11,bc);
  px(x,y+7+bob,4,11,'#8b6344');
  px(x+12,y+7+bob,4,11,'#8b6344');
  px(x+2,y+15+bob,12,3,'#8b6344');
  // head
  px(x+2,y+1+bob,12,7,bc);
  px(x+2,y+1+bob,4,5,'#8b6344');
  px(x+10,y+1+bob,4,5,'#8b6344');
  // ears
  px(x+2,y-2+bob,4,4,'#8b6344');
  px(x+10,y-2+bob,4,4,'#8b6344');
  px(x+3,y-1+bob,2,2,'#f9a8d4');
  px(x+11,y-1+bob,2,2,'#f9a8d4');
  // eyes
  px(x+4,y+3+bob,3,2,'#60a5fa');
  px(x+9,y+3+bob,3,2,'#60a5fa');
  px(x+5,y+3+bob,1,2,'#111');
  px(x+10,y+3+bob,1,2,'#111');
  // nose
  px(x+7,y+6+bob,2,1,'#f9a8d4');
  // whiskers
  px(x-2,y+6+bob,5,1,'#ccc');
  px(x+13,y+6+bob,5,1,'#ccc');
  // legs
  const lg=player.onGround?Math.sin(fr*0.4)*2:2;
  px(x+2,y+17+bob,4,4+lg,'#8b6344');
  px(x+10,y+17+bob,4,4-lg,'#8b6344');
  if(pow){pxA(x-2,y-4,20,28,'#fbbf24',0.25);}
  ctx.restore();
}

function drawDog(x,y,fr,alive){
  if(!alive) return;
  const b=Math.floor(fr/10)%2;
  px(x,y+b,14,10,'#92400e');
  px(x+2,y-4+b,10,6,'#92400e');
  px(x+1,y-5+b,3,4,'#78350f');
  px(x+9,y-5+b,3,4,'#78350f');
  px(x+3,y-2+b,2,2,'#fff');
  px(x+8,y-2+b,2,2,'#fff');
  px(x+4,y-2+b,1,2,'#000');
  px(x+9,y-2+b,1,2,'#000');
  px(x+5,y+2+b,3,1,'#000');
  px(x+2,y+10,3,5,'#92400e');
  px(x+9,y+10,3,5,'#92400e');
}

function drawCat2Enemy(x,y,fr){ // ninja cat enemy (lv2)
  const b=Math.floor(fr/8)%2;
  px(x+2,y+b,10,9,'#1e1b4b');
  px(x+3,y-4+b,8,6,'#1e1b4b');
  px(x+3,y-2+b,2,2,'#ef4444');
  px(x+9,y-2+b,2,2,'#ef4444');
  px(x+2,y+9,4,5,'#1e1b4b');
  px(x+8,y+9,4,5,'#1e1b4b');
}

function drawBoss1(x,y,fr,hp,maxhp){ // Big dog boss lv1
  const b=Math.sin(fr*0.08)*2, stun=boss&&boss.stunTimer>0;
  const bc=stun?'#ef4444':'#7c2d12';
  px(x,y+10+b,44,28,bc);
  px(x+4,y+b,36,16,'#92400e');
  px(x+2,y-6+b,9,9,'#78350f');
  px(x+28,y-6+b,9,9,'#78350f');
  px(x+7,y+2+b,6,5,stun?'#fff':'#fef3c7');
  px(x+22,y+2+b,6,5,stun?'#fff':'#fef3c7');
  px(x+8,y+3+b,3,3,'#000');
  px(x+23,y+3+b,3,3,'#000');
  if(!stun){px(x+9,y+2+b,2,1,'#ef4444');px(x+24,y+2+b,2,1,'#ef4444');}
  px(x+10,y+10+b,18,2,'#000');
  px(x+10,y+10+b,4,4,'#fff');
  px(x+24,y+10+b,4,4,'#fff');
  px(x+4,y+36,9,10,bc);
  px(x+30,y+36,9,10,bc);
  // hp bar
  const bw=44;
  px(x,y-10,bw,5,'#3f0000');
  px(x,y-10,Math.floor(bw*(hp/maxhp)),5,hp>maxhp/2?'#22c55e':'#ef4444');
  ctx.fillStyle='#fff';ctx.font='7px Courier New';ctx.fillText('BOSS',x,y-12);
}

function drawBoss2(x,y,fr,hp,maxhp){ // Giant ninja cat boss lv2
  const b=Math.sin(fr*0.1)*3, stun=boss&&boss.stunTimer>0;
  const bc=stun?'#ef4444':'#312e81';
  px(x,y+12+b,48,30,bc);
  px(x+4,y+b,40,16,'#3730a3');
  px(x+3,y-8+b,10,10,bc);
  px(x+30,y-8+b,10,10,bc);
  px(x+8,y+2+b,7,6,stun?'#fef3c7':'#ef4444');
  px(x+26,y+2+b,7,6,stun?'#fef3c7':'#ef4444');
  px(x+9,y+3+b,4,4,'#000');
  px(x+27,y+3+b,4,4,'#000');
  px(x+12,y+11+b,20,3,'#000');
  px(x+4,y+40,10,10,bc);
  px(x+32,y+40,10,10,bc);
  const bw=48;
  px(x,y-12,bw,5,'#1e1b4b');
  px(x,y-12,Math.floor(bw*(hp/maxhp)),5,hp>maxhp/2?'#818cf8':'#ef4444');
  ctx.fillStyle='#e0e7ff';ctx.font='7px Courier New';ctx.fillText('BOSS 2',x,y-14);
}

function drawBoss3(x,y,fr,hp,maxhp){ // Robot Dog final boss lv3
  const b=Math.sin(fr*0.12)*2, stun=boss&&boss.stunTimer>0;
  const bc=stun?'#fbbf24':'#374151';
  px(x,y+8+b,52,32,bc);
  px(x+4,y-2+b,44,14,'#1f2937');
  px(x+2,y-10+b,12,12,'#374151');
  px(x+34,y-10+b,12,12,'#374151');
  px(x+6,y+b,8,6,stun?'#fff':'#06b6d4');
  px(x+28,y+b,8,6,stun?'#fff':'#06b6d4');
  px(x+8,y+1+b,4,4,'#000');px(x+30,y+1+b,4,4,'#000');
  // antenna
  px(x+24,y-14+b,3,8,'#9ca3af');
  px(x+21,y-15+b,9,3,'#f59e0b');
  // mouth
  for(let i=0;i<5;i++) px(x+12+i*5,y+9+b,3,3,'#000');
  px(x+4,y+38,10,12,bc);px(x+36,y+38,10,12,bc);
  // rockets when hp low
  if(hp<maxhp/2){
    pxA(x+10,y+38,8,14,'#f97316',0.7+Math.sin(fr*0.5)*0.3);
    pxA(x+32,y+38,8,14,'#f97316',0.7+Math.cos(fr*0.5)*0.3);
  }
  const bw=52;
  px(x,y-14,bw,5,'#111827');
  px(x,y-14,Math.floor(bw*(hp/maxhp)),5,hp>maxhp*0.66?'#22c55e':hp>maxhp*0.33?'#f59e0b':'#ef4444');
  ctx.fillStyle='#6ee7b7';ctx.font='7px Courier New';ctx.fillText('BOSS FINAL',x,y-16);
}

function drawFish(x,y){
  px(x+2,y+2,8,4,'#60a5fa');px(x,y+3,3,2,'#93c5fd');
  px(x+10,y+1,4,3,'#3b82f6');px(x+10,y+4,4,3,'#3b82f6');
  px(x+6,y+2,2,1,'#fff');
}
function drawMilk(x,y){
  px(x+2,y,8,2,'#e2d9f3');px(x+1,y+2,10,8,'#f8fafc');px(x+3,y+1,6,2,'#fff');
}
function drawCoin(x,y,f){
  const c=Math.floor(f/8)%2===0?'#fbbf24':'#f59e0b';
  px(x+1,y,6,8,c);px(x,y+1,8,6,c);px(x+2,y+2,4,4,'#fde68a');
}
function drawKey(x,y){
  px(x+2,y,6,6,'#fbbf24');px(x+1,y+1,8,4,'#fbbf24');
  px(x+8,y+6,2,6,'#fbbf24');px(x+6,y+10,4,2,'#fbbf24');px(x+6,y+8,2,2,'#fde68a');
}
function drawDoor(x,y,open){
  px(x,y,24,40,open?'#22c55e':'#991b1b');
  px(x+2,y+2,20,36,open?'#16a34a':'#7f1d1d');
  px(x+8,y+16,8,8,'#fbbf24');
  if(!open) px(x+10,y+18,4,4,'#000');
  ctx.fillStyle=open?'#bbf7d0':'#fca5a5';ctx.font='7px Courier New';
  ctx.textAlign='center';ctx.fillText(open?'OPEN':'LOCK',x+12,y-3);ctx.textAlign='left';
}

// ‚îÄ‚îÄ LEVEL DEFINITIONS ‚îÄ‚îÄ
const LEVELS=[
  { // LV 1 ‚Äî Vila do Gato
    name:'Vila do Gato',
    bgCols:['#1a0a2e','#2e1065'],
    gridCol:'#3b1f6e', grassCol:'#7c3aed',
    w:2400,
    missions:['Derrote 3 cachorros inimigos','Colete 6 peixinhos','Encontre a chave e abra a porta!'],
    platCols:['#3b1f6e','#4c1d95','#5b21b6','#6d28d9'],
    platforms:[
      {x:0,y:288,w:2400,h:32},{x:150,y:240,w:90,h:12},{x:300,y:200,w:80,h:12},
      {x:420,y:245,w:70,h:12},{x:540,y:195,w:100,h:12},{x:680,y:245,w:80,h:12},
      {x:800,y:195,w:90,h:12},{x:950,y:240,w:80,h:12},{x:1080,y:190,w:100,h:12},
      {x:1230,y:240,w:80,h:12},{x:1360,y:185,w:90,h:12},{x:1500,y:235,w:80,h:12},
      {x:1630,y:185,w:100,h:12},{x:1780,y:240,w:80,h:12},{x:1900,y:190,w:90,h:12},
      {x:2050,y:235,w:80,h:12},{x:2180,y:185,w:100,h:12},{x:2320,y:265,w:80,h:12},
    ],
    coins:[[170,220],[320,180],[540,175],[700,225],[820,175],[970,220],[1100,170],
           [1250,220],[1380,165],[1520,215],[1650,165],[1800,220],[1920,170],[2070,215],[2200,165]],
    enemies:[
      {x:400,y:265,vx:-1.2},{x:750,y:265,vx:1},{x:1100,y:265,vx:-1.2},
      {x:1500,y:265,vx:1},{x:1900,y:265,vx:-1},{x:2200,y:265,vx:1.2},
    ],
    powerups:[{x:540,y:170,type:'milk'},{x:1080,y:165,type:'fish'},{x:1900,y:165,type:'milk'}],
    keyPos:{x:2180,y:162},
    doorPos:{x:2340,y:248},
    bossHp:25, bossX:1200,
    enemyNeeded:3, fishNeeded:6,
  },
  { // LV 2 ‚Äî Floresta Ninja
    name:'Floresta Ninja',
    bgCols:['#052e16','#064e3b'],
    gridCol:'#14532d', grassCol:'#16a34a',
    w:2600,
    missions:['Derrote 4 gatos ninja','Colete 8 peixinhos','Encontre a chave e abra a porta!'],
    platCols:['#14532d','#166534','#15803d','#16a34a'],
    platforms:[
      {x:0,y:288,w:2600,h:32},{x:120,y:238,w:80,h:12},{x:260,y:198,w:80,h:12},
      {x:390,y:248,w:70,h:12},{x:510,y:195,w:90,h:12},{x:650,y:245,w:80,h:12},
      {x:770,y:195,w:90,h:12},{x:910,y:238,w:80,h:12},{x:1040,y:185,w:100,h:12},
      {x:1190,y:238,w:80,h:12},{x:1320,y:182,w:90,h:12},{x:1460,y:232,w:80,h:12},
      {x:1590,y:180,w:100,h:12},{x:1740,y:238,w:80,h:12},{x:1870,y:185,w:90,h:12},
      {x:2020,y:232,w:80,h:12},{x:2150,y:180,w:100,h:12},{x:2300,y:238,w:80,h:12},
      {x:2430,y:182,w:90,h:12},{x:2520,y:260,w:80,h:12},
    ],
    coins:[[140,218],[280,178],[530,175],[670,225],[790,175],[930,218],[1060,165],
           [1210,218],[1340,162],[1480,212],[1610,160],[1760,218],[1890,165],[2040,212],[2170,160],[2320,218],[2450,162]],
    enemies:[
      {x:350,y:265,vx:-1.4},{x:650,y:265,vx:1.2},{x:1000,y:265,vx:-1.4},
      {x:1400,y:265,vx:1.2},{x:1800,y:265,vx:-1.4},{x:2100,y:265,vx:1.2},{x:2400,y:265,vx:-1},
    ],
    powerups:[{x:510,y:170,type:'milk'},{x:1040,y:160,type:'fish'},{x:1870,y:160,type:'milk'},{x:2150,y:155,type:'fish'}],
    keyPos:{x:2430,y:158},
    doorPos:{x:2530,y:248},
    bossHp:35, bossX:1300,
    enemyNeeded:4, fishNeeded:8,
  },
  { // LV 3 ‚Äî Castelo do Rob√¥
    name:'Castelo do Rob√¥',
    bgCols:['#0f172a','#1e293b'],
    gridCol:'#1e293b', grassCol:'#475569',
    w:2800,
    missions:['Derrote 5 rob√¥s','Colete 10 peixinhos','Destrua o Boss Final!'],
    platCols:['#1e293b','#334155','#475569','#64748b'],
    platforms:[
      {x:0,y:288,w:2800,h:32},{x:100,y:235,w:90,h:12},{x:250,y:192,w:80,h:12},
      {x:380,y:245,w:70,h:12},{x:500,y:190,w:90,h:12},{x:640,y:240,w:80,h:12},
      {x:760,y:188,w:90,h:12},{x:900,y:235,w:80,h:12},{x:1030,y:182,w:100,h:12},
      {x:1180,y:235,w:80,h:12},{x:1310,y:178,w:90,h:12},{x:1450,y:228,w:80,h:12},
      {x:1580,y:176,w:100,h:12},{x:1730,y:235,w:80,h:12},{x:1860,y:180,w:90,h:12},
      {x:2010,y:228,w:80,h:12},{x:2140,y:175,w:100,h:12},{x:2290,y:228,w:80,h:12},
      {x:2420,y:175,w:90,h:12},{x:2570,y:228,w:80,h:12},{x:2680,y:255,w:120,h:12},
    ],
    coins:[[120,215],[270,172],[520,170],[660,220],[780,168],[920,215],[1050,162],
           [1200,215],[1330,158],[1470,208],[1600,156],[1750,215],[1880,160],[2030,208],[2160,155],
           [2310,208],[2440,155],[2590,208],[2700,235]],
    enemies:[
      {x:300,y:265,vx:-1.5},{x:600,y:265,vx:1.3},{x:950,y:265,vx:-1.5},
      {x:1300,y:265,vx:1.3},{x:1700,y:265,vx:-1.5},{x:2000,y:265,vx:1.3},
      {x:2300,y:265,vx:-1.5},{x:2600,y:265,vx:1.3},
    ],
    powerups:[{x:500,y:165,type:'milk'},{x:1030,y:157,type:'fish'},{x:1580,y:151,type:'milk'},{x:2140,y:150,type:'fish'},{x:2420,y:150,type:'milk'}],
    keyPos:{x:2680,y:232},
    doorPos:{x:2720,y:242},
    bossHp:50, bossX:1400,
    enemyNeeded:5, fishNeeded:10,
  }
];

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ
let state='title', frame=0, lv=0;
let player, platforms, coins, enemies, powerups, particles, boss, bossActive, bossDefeated;
let keyObj, door, hasKey;
let camX=0, score=0, lives=3, powerTimer=0, invTimer=0;
let missionStep=0, enemiesKilled=0, fishCollected=0;
let keys={};
const GRAV=0.42, JUMP=-9.2, SPD=2.8, BOSS_MAX_HP=[25,35,50];

function initLevel(idx){
  lv=idx; const L=LEVELS[lv];
  bossActive=false; bossDefeated=false; boss=null;
  particles=[]; powerTimer=0; invTimer=0;
  camX=0; missionStep=0; enemiesKilled=0; fishCollected=0;
  hasKey=false;

  player={x:40,y:240,vx:0,vy:0,onGround:false,dir:1,anim:0,w:16,h:22};

  platforms=L.platforms.map((p,i)=>({...p,col:L.platCols[i%L.platCols.length]}));
  coins=L.coins.map(([x,y])=>({x,y,alive:true,anim:Math.random()*16}));
  enemies=L.enemies.map(e=>({...e,alive:true,w:14,h:16,anim:0}));
  powerups=L.powerups.map(p=>({...p,alive:true}));
  keyObj={x:L.keyPos.x,y:L.keyPos.y,alive:true};
  door={x:L.doorPos.x,y:L.doorPos.y,open:false};

  updateHUD(); updateMission();
}

function updateMission(){
  const L=LEVELS[lv];
  const msgs=[
    `üéØ Miss√£o 1/3: Derrote inimigos (${enemiesKilled}/${L.enemyNeeded})`,
    `üéØ Miss√£o 2/3: Colete peixes (${fishCollected}/${L.fishNeeded})`,
    `üéØ Miss√£o 3/3: Pegue a chave üîë e abra a porta!`,
    bossDefeated?`‚úÖ Fase ${lv+1} completa! Pressione ENTER para avan√ßar`:`üéØ Miss√£o ${lv===2?'FINAL':'3/3'}: Derrote o BOSS! (${boss?boss.hp:0} HP restantes)`
  ];
  const step=missionStep>=3?(bossDefeated?3:3):missionStep;
  document.getElementById('mission').textContent=msgs[Math.min(step,3)];
}

function checkMission(){
  const L=LEVELS[lv];
  if(missionStep===0 && enemiesKilled>=L.enemyNeeded){ missionStep=1; showMsg('‚úÖ Miss√£o 1 completa! Agora colete os peixes!'); updateMission(); }
  if(missionStep===1 && fishCollected>=L.fishNeeded){ missionStep=2; showMsg('‚úÖ Miss√£o 2 completa! Ache a chave!'); updateMission(); }
  if(missionStep===2 && hasKey && !door.open){
    door.open=true;
    if(lv<2){ showMsg('üö™ Porta aberta! Mas o boss apareceu! ‚ö†Ô∏è'); spawnBoss(); }
    else { showMsg('üö™ Porta aberta! Boss Final apareceu! ‚ö†Ô∏è‚ö†Ô∏è'); spawnBoss(); }
    missionStep=3; updateMission();
  }
}

function spawnBoss(){
  const L=LEVELS[lv];
  bossActive=true;
  boss={x:L.bossX,y:200,vx:-2,vy:0,hp:L.bossHp,maxHp:L.bossHp,anim:0,w:lv===2?48:lv===3?52:44,h:lv===2?50:lv===3?55:46,stunTimer:0,phase2:false,projTimer:0};
}

// ‚îÄ‚îÄ PROJECTILES (boss phase 2) ‚îÄ‚îÄ
let projs=[];
function spawnProj(x,y){
  const dx=player.x-x, dy=player.y-y;
  const len=Math.sqrt(dx*dx+dy*dy)||1;
  projs.push({x,y,vx:dx/len*3,vy:dy/len*3,life:120});
}

// ‚îÄ‚îÄ PHYSICS ‚îÄ‚îÄ
function updatePlayer(){
  if(state!=='play') return;
  player.anim++;
  const pow=powerTimer>0;
  if(keys['ArrowLeft']||keys['a']||mkeys.left){player.vx=-(SPD*(pow?1.6:1));player.dir=-1;}
  else if(keys['ArrowRight']||keys['d']||mkeys.right){player.vx=SPD*(pow?1.6:1);player.dir=1;}
  else player.vx*=0.72;

  if((keys['z']||keys[' ']||keys['ArrowUp']||mkeys.jump)&&player.onGround){
    player.vy=JUMP*(pow?1.15:1);player.onGround=false;
    spawnParts(player.x+8,player.y+22,'#a78bfa',4);
  }
  player.vy+=GRAV; player.x+=player.vx; player.y+=player.vy;
  player.onGround=false;

  for(const p of platforms){
    if(player.x+player.w>p.x&&player.x<p.x+p.w&&
       player.y+player.h>p.y&&player.y+player.h<p.y+p.h+Math.max(player.vy,1)+2&&player.vy>=0){
      player.y=p.y-player.h; player.vy=0; player.onGround=true;
    }
  }
  if(player.y>360) loseLife();
  if(powerTimer>0) powerTimer--;
  if(invTimer>0) invTimer--;
}

function updateEnemies(){
  for(const e of enemies){
    if(!e.alive) continue;
    e.anim++;
    e.x+=e.vx;
    let onP=false;
    for(const p of platforms){
      if(e.x+e.w>p.x&&e.x<p.x+p.w&&e.y+e.h>=p.y&&e.y+e.h<=p.y+14) onP=true;
    }
    if(!onP||e.x<10) e.vx*=-1;
    if(overlap(player,e)){
      if(invTimer===0){
        if(player.vy>0&&player.y+player.h<e.y+6){
          e.alive=false; player.vy=-6.5; score+=10;
          enemiesKilled++; spawnParts(e.x+7,e.y,'#fbbf24',7);
          checkMission(); updateHUD();
        } else loseLife();
      }
    }
  }
}

function updateBoss(){
  if(!boss) return;
  boss.anim++; boss.stunTimer=Math.max(0,boss.stunTimer-1);
  boss.x+=boss.vx;
  boss.vy+=GRAV*0.6; boss.y+=boss.vy;
  // land on floor
  for(const p of platforms){
    if(boss.x+boss.w>p.x&&boss.x<p.x+p.w&&
       boss.y+boss.h>p.y&&boss.y+boss.h<p.y+boss.h+2&&boss.vy>=0){
      boss.y=p.y-boss.h; boss.vy=0;
    }
  }
  if(boss.x<30||boss.x>LEVELS[lv].w-boss.w-30) boss.vx*=-1;

  // phase 2 jump when hp < half
  if(boss.hp<boss.maxHp/2 && !boss.phase2){ boss.phase2=true; boss.vx*=1.4; showMsg('‚ö†Ô∏è Boss entrou em f√∫ria!'); }
  if(boss.phase2 && boss.onGround) boss.vy=-7;
  if(boss.y+boss.h<300) boss.onGround=false; else boss.onGround=true;

  // projectile (lv3 boss only)
  if(lv===2 && boss.phase2){
    boss.projTimer++;
    if(boss.projTimer>80){ boss.projTimer=0; spawnProj(boss.x+boss.w/2,boss.y+boss.h/2); }
  }

  // player vs boss
  if(invTimer===0&&overlap(player,boss)){
    if(player.vy>1&&player.y+player.h<boss.y+16&&boss.stunTimer===0){
      boss.hp--; boss.stunTimer=40; player.vy=-7.5; score+=15;
      spawnParts(boss.x+boss.w/2,boss.y,'#ef4444',8);
      updateMission();
      if(boss.hp<=0){
        bossActive=false; bossDefeated=true; boss=null; projs=[];
        score+=100; updateHUD();
        if(lv<2){ showMsg('üèÜ Boss derrotado! ENTER para pr√≥xima fase!'); state='levelclear'; }
        else { showMsg('üèÜüéâ VOC√ä VENCEU O JOGO! Parab√©ns!! ENTER'); state='win'; }
        updateMission();
      }
    } else loseLife();
  }
}

function updateProjs(){
  for(let i=projs.length-1;i>=0;i--){
    const p=projs[i];
    p.x+=p.vx; p.y+=p.vy; p.life--;
    if(p.life<=0){projs.splice(i,1);continue;}
    if(invTimer===0&&overlap(player,{x:p.x,y:p.y,w:6,h:6})){ loseLife(); projs.splice(i,1); }
  }
}

function updateCoins(){
  for(const c of coins){
    if(!c.alive) continue; c.anim++;
    if(overlap(player,{x:c.x,y:c.y,w:8,h:8})){
      c.alive=false; score+=2; fishCollected++;
      spawnParts(c.x,c.y,'#fbbf24',5); checkMission(); updateHUD();
    }
  }
}

function updatePowerups(){
  for(const p of powerups){
    if(!p.alive) continue;
    if(overlap(player,{x:p.x,y:p.y,w:12,h:10})){
      p.alive=false;
      if(p.type==='milk'){powerTimer=350;showMsg('ü•õ Leite! Super modo ativado!');}
      else{lives=Math.min(5,lives+1);score+=20;showMsg('üêü Peixe m√°gico! +1 vida!');}
      spawnParts(p.x,p.y,'#a78bfa',8); updateHUD();
    }
  }
}

function updateKey(){
  if(!keyObj.alive) return;
  if(overlap(player,{x:keyObj.x,y:keyObj.y,w:10,h:14})){
    keyObj.alive=false; hasKey=true;
    showMsg('üîë Chave coletada! V√° at√© a porta!'); checkMission();
  }
}

function loseLife(){
  if(invTimer>0) return;
  lives--; invTimer=100;
  spawnParts(player.x+8,player.y+11,'#ef4444',10); updateHUD();
  if(lives<=0){ state='over'; showMsg('üòø Game Over! ENTER = tentar de novo'); }
}

function overlap(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

function spawnParts(x,y,col,n){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,sp=Math.random()*3+1;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1.5,life:30,col});
  }
}

function updateParts(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life--;
    if(p.life<=0) particles.splice(i,1);
  }
}

function updateCam(){
  const L=LEVELS[lv];
  camX+=(player.x-180-camX)*0.12;
  camX=Math.max(0,Math.min(L.w-512,camX));
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
function drawBg(){
  const L=LEVELS[lv];
  const g=ctx.createLinearGradient(0,0,0,320);
  g.addColorStop(0,L.bgCols[0]);g.addColorStop(1,L.bgCols[1]);
  ctx.fillStyle=g;ctx.fillRect(0,0,512,320);
  // stars
  ctx.fillStyle='#ffffff18';
  for(let i=0;i<40;i++) ctx.fillRect(((i*137+frame*0.15)%512+512)%512,(i*73)%200,1,1);
}

function drawWorld(){
  ctx.save();ctx.translate(-camX,0);
  const L=LEVELS[lv];

  // platforms
  for(const p of platforms){
    px(p.x,p.y,p.w,p.h,p.col);
    pxA(p.x,p.y,p.w,3,'#ffffff',0.1);
    if(p.h>20) for(let gx=p.x;gx<p.x+p.w;gx+=4) px(gx,p.y-2,2,3,L.grassCol);
  }

  // door
  drawDoor(door.x,door.y,door.open);

  // key
  if(keyObj.alive) drawKey(keyObj.x,keyObj.y);

  // coins
  for(const c of coins) if(c.alive) drawCoin(c.x,c.y,c.anim);

  // powerups
  for(const p of powerups){
    if(!p.alive) continue;
    if(p.type==='milk') drawMilk(p.x,p.y); else drawFish(p.x,p.y);
    // floating bob
    pxA(p.x,p.y-2+Math.sin(frame*0.08)*3,12,2,'#fff',0.15);
  }

  // enemies
  for(const e of enemies){
    if(!e.alive) continue;
    if(lv===0) drawDog(e.x,e.y,e.anim,true);
    else drawCat2Enemy(e.x,e.y,e.anim);
  }

  // boss
  if(boss){
    if(lv===0) drawBoss1(boss.x,boss.y,boss.anim,boss.hp,boss.maxHp);
    else if(lv===1) drawBoss2(boss.x,boss.y,boss.anim,boss.hp,boss.maxHp);
    else drawBoss3(boss.x,boss.y,boss.anim,boss.hp,boss.maxHp);
  }

  // projectiles
  for(const p of projs){
    ctx.globalAlpha=p.life/120;
    px(p.x,p.y,6,6,'#f97316');
    ctx.globalAlpha=1;
  }

  // particles
  for(const p of particles){
    ctx.globalAlpha=p.life/30;
    px(p.x,p.y,3,3,p.col);
  }
  ctx.globalAlpha=1;

  // player
  drawCat(player.x,player.y,player.anim,player.dir,powerTimer>0,invTimer);

  ctx.restore();
}

function drawHUDOverlay(){
  // power bar
  if(powerTimer>0){
    px(8,8,104,7,'#1e1b4b');
    px(8,8,Math.floor(104*powerTimer/350),7,'#f59e0b');
    ctx.fillStyle='#fde68a';ctx.font='7px Courier New';ctx.fillText('POWER',114,14);
  }
  // key indicator
  if(hasKey&&!door.open){
    ctx.fillStyle='#fbbf24';ctx.font='9px Courier New';ctx.fillText('üîë CHAVE',8,28);
  }
}

// ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ
function drawTitle(){
  const g=ctx.createLinearGradient(0,0,0,320);
  g.addColorStop(0,'#1a0a2e');g.addColorStop(1,'#2e1065');
  ctx.fillStyle=g;ctx.fillRect(0,0,512,320);
  for(let i=0;i<50;i++) ctx.fillRect((i*137+frame)%512,(i*73)%230,Math.random()>0.98?2:1,1);

  ctx.textAlign='center';
  ctx.fillStyle='#fbbf24';ctx.font='bold 26px Courier New';
  ctx.fillText('üê± NEKO ADVENTURE üê±',256,65);
  ctx.fillStyle='#a78bfa';ctx.font='11px Courier New';
  ctx.fillText('A grande aventura do gatinho siam√™s!',256,88);

  drawCat(240,110,frame,1,false,0);

  ctx.fillStyle='#c4b5fd';ctx.font='10px Courier New';
  ctx.fillText('3 FASES  ‚Ä¢  CHEF√ïES  ‚Ä¢  MISS√ïES  ‚Ä¢  POWER-UPS',256,180);

  ctx.fillStyle='#fff';ctx.font='12px Courier New';
  const blink=Math.floor(frame/20)%2===0;
  if(blink) ctx.fillText('‚ñ∂  Pressione ENTER para jogar  ‚óÄ',256,220);

  ctx.fillStyle='#6d28d9';ctx.font='9px Courier New';
  ctx.fillText('‚Üê ‚Üí mover  |  Z / ESPA√áO pular  |  Pise nos inimigos!',256,268);
  ctx.textAlign='left';
}

function drawLevelClear(){
  ctx.fillStyle='#000000aa';ctx.fillRect(100,80,312,160);
  px(100,80,312,4,'#fbbf24');px(100,236,312,4,'#fbbf24');
  ctx.textAlign='center';
  ctx.fillStyle='#fbbf24';ctx.font='bold 18px Courier New';
  ctx.fillText('üèÜ FASE COMPLETA!',256,120);
  ctx.fillStyle='#a78bfa';ctx.font='11px Courier New';
  ctx.fillText(`Fase ${lv+1} ‚Äî ${LEVELS[lv].name}`,256,148);
  ctx.fillStyle='#fff';ctx.font='10px Courier New';
  ctx.fillText(`Score: ${score}  |  Vidas: ${lives}`,256,170);
  const blink=Math.floor(frame/20)%2===0;
  ctx.fillStyle=blink?'#fbbf24':'#a78bfa';
  ctx.fillText('ENTER ‚Üí pr√≥xima fase',256,210);
  ctx.textAlign='left';
}

function drawGameOver(){
  ctx.fillStyle='#000000bb';ctx.fillRect(80,90,352,150);
  ctx.textAlign='center';
  ctx.fillStyle='#ef4444';ctx.font='bold 20px Courier New';
  ctx.fillText('üòø GAME OVER',256,130);
  ctx.fillStyle='#fca5a5';ctx.font='11px Courier New';
  ctx.fillText(`Score final: ${score}`,256,158);
  ctx.fillStyle='#fff';ctx.font='10px Courier New';
  ctx.fillText('ENTER ‚Üí tentar de novo',256,195);
  ctx.textAlign='left';
}

function drawWin(){
  ctx.fillStyle='#000000bb';ctx.fillRect(60,60,392,200);
  ctx.textAlign='center';
  ctx.fillStyle='#fbbf24';ctx.font='bold 18px Courier New';
  ctx.fillText('üèÜ PARAB√âNS! VOC√ä GANHOU! üèÜ',256,105);
  ctx.fillStyle='#a78bfa';ctx.font='11px Courier New';
  ctx.fillText('Voc√™ completou as 3 fases!',256,130);
  ctx.fillStyle='#6ee7b7';ctx.font='10px Courier New';
  ctx.fillText(`Score final: ${score}  |  Fases: 3/3`,256,155);
  ctx.fillStyle='#fde68a';ctx.font='9px Courier New';
  ctx.fillText('O gatinho siam√™s salvou o dia! üê±',256,178);
  const blink=Math.floor(frame/20)%2===0;
  ctx.fillStyle=blink?'#fbbf24':'#fff';
  ctx.fillText('ENTER ‚Üí jogar de novo',256,218);
  ctx.textAlign='left';
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ
function updateHUD(){
  const L=LEVELS[lv]||LEVELS[0];
  document.getElementById('hpV').textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));
  document.getElementById('scV').textContent=score;
  document.getElementById('lvV').textContent=lv+1;
  document.getElementById('enV').textContent=enemiesKilled;
  document.getElementById('fishV').textContent=`${fishCollected}/${L.fishNeeded}`;
  document.getElementById('pwV').textContent=powerTimer>0?'ü•õ':'‚Äî';
}

let msgTimer=0,msgText='';
function showMsg(t){msgText=t;msgTimer=220;document.getElementById('mission').textContent=t;}
function tickMsg(){if(msgTimer>0){msgTimer--;if(msgTimer===0)updateMission();}}

// ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ
function gameLoop(){
  frame++;
  ctx.clearRect(0,0,512,320);
  tickMsg();

  if(state==='title'){ drawTitle(); }
  else if(state==='play'){
    updateCam(); updatePlayer(); updateEnemies();
    if(bossActive) updateBoss();
    updateProjs(); updateCoins(); updatePowerups();
    updateKey(); updateParts();
    drawBg(); drawWorld(); drawHUDOverlay();
  } else if(state==='levelclear'){
    updateCam(); drawBg(); drawWorld(); drawHUDOverlay(); drawLevelClear();
  } else if(state==='over'){
    updateCam(); drawBg(); drawWorld(); drawHUDOverlay(); drawGameOver();
  } else if(state==='win'){
    updateCam(); drawBg(); drawWorld(); drawHUDOverlay(); drawWin();
  }

  requestAnimationFrame(gameLoop);
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(e.key==='Enter'){
    if(state==='title'||state==='over'){ score=0;lives=3;initLevel(0);state='play'; }
    else if(state==='levelclear'){ initLevel(lv+1);state='play'; }
    else if(state==='win'){ score=0;lives=3;initLevel(0);state='play'; }
  }
  if([' ','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
});
document.addEventListener('keyup',e=>keys[e.key]=false);

// ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ
const mkeys={left:false,right:false,jump:false};
function mb(id,k){
  const el=document.getElementById(id); if(!el) return;
  el.addEventListener('touchstart',e=>{e.preventDefault();mkeys[k]=true;},{passive:false});
  el.addEventListener('touchend',e=>{e.preventDefault();mkeys[k]=false;},{passive:false});
}
mb('btnL','left');mb('btnR','right');mb('btnJ','jump');

gameLoop();
</script>
</body>
</html>
